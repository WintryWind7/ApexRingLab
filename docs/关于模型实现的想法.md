# 关于模型实现的想法

## 目标

实现类似 Sabaki + Leela 的效果：在地图上显示毒圈预测的概率分布热力图，并高亮 Top-K 个高概率候选点。

## 预测任务

- **模式 A**：输入第 1 级毒圈 → 预测第 2、3 级
- **模式 B**：输入第 1、2 级毒圈 → 预测第 3 级

暂不考虑第 4 级。

## 方案对比

### 方案 1：分类模型（网格化）

**做法**：
- 将地图划分为 N×N 网格（如 128×128、256×256）
- 模型输出每个网格的概率（Softmax，总和为 1）
- 使用交叉熵损失训练

**优势**：
- 天然输出概率分布，符合可视化需求
- 可以直接绘制热力图
- 类似围棋 AI 的做法，成熟可靠

**问题**：
- **精度受限于网格大小**
  - 128×128：每格 128 坐标单位（太粗糙）
  - 256×256：每格 64 坐标单位（勉强可用）
  - 512×512：每格 32 坐标单位（较精确，但输出 262,144 类）
  - 4096×4096：每格 4 坐标单位（理想精度，但输出 16,777,216 类，不现实）

- **计算量问题**
  - 网格越大，Softmax 计算量越大
  - 显存需求随网格平方增长

### 方案 2：回归模型

**做法**：
- 直接预测坐标 (x, y)
- 使用 MSE 或 Smooth L1 损失

**问题**：
- **无法输出概率分布**
- 只能预测一个点，无法展示多个候选位置
- 不符合"显示热力图"的需求

### 方案 3：混合密度网络（MDN）

**做法**：
- 输出 K 个高斯分布的混合：每个分布包含 (μx, μy, σx, σy, weight)
- 可以表示多个候选点及其不确定性

**问题**：
- 实现复杂
- 需要预先定义混合数量 K
- 热力图需要手动渲染高斯分布，不如分类模型直观

### 方案 4：粗网格 + 上采样可视化

**做法**：
- 训练时输出 256×256 概率图
- 推理时用双线性插值上采样到 4096×4096 显示

**优势**：
- 训练简单（256×256）
- 可视化精细（4096×4096）
- 热力图平滑自然

**问题**：
- **实际预测精度仍然是 64 单位**（受限于 256 网格）
- 上采样只是视觉效果，不能提高真实精度
- 预测的坐标只能是 256 个网格中心之一

### 方案 5：两阶段预测（粗定位 + 精细回归）

**做法**：
- **阶段 1**：粗定位模型输出 256×256 概率图，找到 Top-5 候选区域
- **阶段 2**：精细回归模型对每个候选区域预测偏移量 (Δx, Δy)
- 最终坐标 = 区域中心 + 偏移量

**优势**：
- 保留概率分布的可视化（热力图）
- 精度不受网格限制（回归可以输出任意坐标）
- 计算量可控（粗定位只需 256×256）

**问题**：
- 需要训练两个模型
- 实现复杂度较高
- 阶段 1 的错误会影响阶段 2（如果真实位置不在 Top-5 中）

**可视化方案**：
- 上采样粗定位热力图到 4096×4096
- 在精确坐标位置叠加高斯分布峰值
- 既有全局概率分布，又有精确的候选点

### 方案 6：分层网络（渐进式上采样）

**做法**：
- 类似图像分割网络
- Encoder 提取特征 → Decoder 逐步上采样
- 64×64 → 128×128 → 256×256 → 512×512

**优势**：
- 可以输出更高分辨率（512×512）
- 渐进式生成，计算相对可控

**问题**：
- 网络结构复杂
- 训练时间长
- 仍然无法达到 4096×4096 的真实精度

## 核心矛盾

**需求**：4096×4096 的精细热力图（每格 4 坐标单位）

**现实**：
- 直接输出 4096×4096 = 1600 万类，计算不可行
- 低分辨率网格（256×256）精度不够
- 上采样只是视觉效果，不能提高预测精度

